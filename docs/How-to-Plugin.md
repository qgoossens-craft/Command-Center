# Guide Technique : Développement de Plugin Obsidian
*Instructions détaillées pour Claude Code*

## 🚀 Vue d'ensemble
Ce guide fournit des instructions étape par étape pour créer un plugin Obsidian from scratch. Le plugin sera développé en TypeScript et utilisera l'API Obsidian.

## 📋 Prérequis

### Environnement de développement
- **Node.js** (version 14 ou supérieure)
- **npm** ou **yarn** pour la gestion des packages
- **IDE** : VS Code recommandé avec extensions TypeScript
- **Git** pour le versioning

### Structure de base requise
```
obsidian-homepage-plugin/
├── manifest.json          # Métadonnées du plugin
├── main.ts               # Point d'entrée principal
├── styles.css            # Styles personnalisés
├── package.json          # Dépendances npm
├── tsconfig.json         # Configuration TypeScript
├── .gitignore           
├── README.md            
└── versions.json         # Historique des versions
```

## 🛠️ Étape 1 : Initialisation du projet

### 1.1 Créer le dossier du plugin
```bash
# Dans le dossier .obsidian/plugins/ de votre vault
mkdir obsidian-homepage-plugin
cd obsidian-homepage-plugin
```

### 1.2 Initialiser npm et installer les dépendances
```bash
npm init -y
npm install -D @types/node typescript obsidian tslib @typescript-eslint/parser @typescript-eslint/eslint-plugin
```

### 1.3 Créer `manifest.json`
```json
{
  "id": "obsidian-homepage",
  "name": "Homepage Plugin",
  "version": "1.0.0",
  "minAppVersion": "1.0.0",
  "description": "A customizable homepage for Obsidian",
  "author": "Your Name",
  "authorUrl": "https://github.com/yourusername",
  "isDesktopOnly": false
}
```

### 1.4 Créer `package.json`
```json
{
  "name": "obsidian-homepage-plugin",
  "version": "1.0.0",
  "description": "Homepage plugin for Obsidian",
  "main": "main.js",
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "tsc -noEmit -skipLibCheck && node esbuild.config.mjs production",
    "version": "node version-bump.mjs && git add manifest.json versions.json"
  },
  "keywords": ["obsidian-plugin"],
  "author": "",
  "license": "MIT",
  "devDependencies": {
    "@types/node": "^16.11.6",
    "@typescript-eslint/eslint-plugin": "5.29.0",
    "@typescript-eslint/parser": "5.29.0",
    "builtin-modules": "3.3.0",
    "esbuild": "0.17.3",
    "obsidian": "latest",
    "tslib": "2.4.0",
    "typescript": "4.7.4"
  }
}
```

### 1.5 Créer `tsconfig.json`
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "inlineSourceMap": true,
    "inlineSources": true,
    "module": "ESNext",
    "target": "ES6",
    "allowJs": true,
    "noImplicitAny": true,
    "moduleResolution": "node",
    "importHelpers": true,
    "isolatedModules": true,
    "strictNullChecks": true,
    "lib": ["DOM", "ES5", "ES6", "ES7"]
  },
  "include": ["**/*.ts"]
}
```

### 1.6 Créer `esbuild.config.mjs`
```javascript
import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === "production");

const context = await esbuild.context({
  banner: {
    js: banner,
  },
  entryPoints: ["main.ts"],
  bundle: true,
  external: [
    "obsidian",
    "electron",
    "@codemirror/autocomplete",
    "@codemirror/collab",
    "@codemirror/commands",
    "@codemirror/language",
    "@codemirror/lint",
    "@codemirror/search",
    "@codemirror/state",
    "@codemirror/view",
    "@lezer/common",
    "@lezer/highlight",
    "@lezer/lr",
    ...builtins],
  format: "cjs",
  target: "es2018",
  logLevel: "info",
  sourcemap: prod ? false : "inline",
  treeShaking: true,
  outfile: "main.js",
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
```

## 📝 Étape 2 : Structure du code principal

### 2.1 Créer `main.ts` - Structure de base
```typescript
import { App, Plugin, PluginSettingTab, Setting, WorkspaceLeaf } from 'obsidian';

// Interface pour les paramètres du plugin
interface HomepageSettings {
    customTitle: string;
    backgroundImage: string;
    showSearch: boolean;
    showBookmarks: boolean;
    showRecentFiles: boolean;
    quotesEnabled: boolean;
}

// Paramètres par défaut
const DEFAULT_SETTINGS: HomepageSettings = {
    customTitle: 'My Homepage',
    backgroundImage: '',
    showSearch: true,
    showBookmarks: true,
    showRecentFiles: true,
    quotesEnabled: true
}

// Classe principale du plugin
export default class HomepagePlugin extends Plugin {
    settings: HomepageSettings;

    async onload() {
        await this.loadSettings();

        // Enregistrer la vue
        this.registerView(
            VIEW_TYPE_HOMEPAGE,
            (leaf) => new HomepageView(leaf, this)
        );

        // Ajouter une commande pour ouvrir la homepage
        this.addCommand({
            id: 'open-homepage',
            name: 'Open Homepage',
            callback: () => {
                this.activateView();
            }
        });

        // Ajouter un bouton dans le ruban
        this.addRibbonIcon('home', 'Homepage', () => {
            this.activateView();
        });

        // Ajouter l'onglet de paramètres
        this.addSettingTab(new HomepageSettingTab(this.app, this));

        // Ouvrir la homepage au démarrage si configuré
        this.app.workspace.onLayoutReady(() => {
            if (this.settings.openOnStartup) {
                this.activateView();
            }
        });
    }

    onunload() {
        // Nettoyer les ressources
    }

    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    }

    async saveSettings() {
        await this.saveData(this.settings);
    }

    async activateView() {
        const { workspace } = this.app;

        let leaf: WorkspaceLeaf | null = null;
        const leaves = workspace.getLeavesOfType(VIEW_TYPE_HOMEPAGE);

        if (leaves.length > 0) {
            // Une vue existe déjà
            leaf = leaves[0];
        } else {
            // Créer une nouvelle vue
            leaf = workspace.getLeaf(false);
            await leaf.setViewState({ type: VIEW_TYPE_HOMEPAGE, active: true });
        }

        // Révéler la feuille
        workspace.revealLeaf(leaf);
    }
}
```

## 🎨 Étape 3 : Créer la vue Homepage

### 3.1 Définir la vue personnalisée
```typescript
import { ItemView, WorkspaceLeaf } from 'obsidian';

export const VIEW_TYPE_HOMEPAGE = 'homepage-view';

class HomepageView extends ItemView {
    plugin: HomepagePlugin;

    constructor(leaf: WorkspaceLeaf, plugin: HomepagePlugin) {
        super(leaf);
        this.plugin = plugin;
    }

    getViewType() {
        return VIEW_TYPE_HOMEPAGE;
    }

    getDisplayText() {
        return 'Homepage';
    }

    getIcon() {
        return 'home';
    }

    async onOpen() {
        const container = this.containerEl.children[1];
        container.empty();
        container.addClass('homepage-container');

        // Construire l'interface
        this.buildHomepage(container);
    }

    async onClose() {
        // Nettoyer si nécessaire
    }

    private buildHomepage(container: HTMLElement) {
        // Ajouter le background si configuré
        if (this.plugin.settings.backgroundImage) {
            container.style.backgroundImage = `url(${this.plugin.settings.backgroundImage})`;
            container.style.backgroundSize = 'cover';
            container.style.backgroundPosition = 'center';
        }

        // Titre personnalisé
        const titleEl = container.createEl('h1', {
            text: this.plugin.settings.customTitle,
            cls: 'homepage-title'
        });

        // Barre de recherche
        if (this.plugin.settings.showSearch) {
            this.createSearchBar(container);
        }

        // Widgets container
        const widgetsContainer = container.createEl('div', {
            cls: 'homepage-widgets'
        });

        // Bookmarks
        if (this.plugin.settings.showBookmarks) {
            this.createBookmarksWidget(widgetsContainer);
        }

        // Fichiers récents
        if (this.plugin.settings.showRecentFiles) {
            this.createRecentFilesWidget(widgetsContainer);
        }

        // Citations
        if (this.plugin.settings.quotesEnabled) {
            this.createQuoteWidget(widgetsContainer);
        }
    }
}
```

## 🔧 Étape 4 : Implémenter les widgets

### 4.1 Widget de recherche
```typescript
private createSearchBar(container: HTMLElement) {
    const searchContainer = container.createEl('div', {
        cls: 'homepage-search-container'
    });

    const searchInput = searchContainer.createEl('input', {
        type: 'text',
        placeholder: 'Search...',
        cls: 'homepage-search-input'
    });

    searchInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value;
            // Utiliser l'API de recherche d'Obsidian
            this.app.workspace.openLinkText(query, '', true);
        }
    });
}
```

### 4.2 Widget des bookmarks
```typescript
private async createBookmarksWidget(container: HTMLElement) {
    const bookmarksEl = container.createEl('div', {
        cls: 'homepage-widget homepage-bookmarks'
    });

    bookmarksEl.createEl('h3', { text: 'Bookmarks' });

    // Récupérer les bookmarks via l'API
    const bookmarks = this.app.vault.getConfig('bookmarks');
    
    if (bookmarks && bookmarks.length > 0) {
        const bookmarksList = bookmarksEl.createEl('ul');
        
        bookmarks.forEach((bookmark: any) => {
            const li = bookmarksList.createEl('li');
            const link = li.createEl('a', {
                text: bookmark.title || bookmark.path,
                href: '#'
            });
            
            link.addEventListener('click', (e) => {
                e.preventDefault();
                this.app.workspace.openLinkText(bookmark.path, '', false);
            });
        });
    }
}
```

### 4.3 Widget des fichiers récents
```typescript
private createRecentFilesWidget(container: HTMLElement) {
    const recentEl = container.createEl('div', {
        cls: 'homepage-widget homepage-recent-files'
    });

    recentEl.createEl('h3', { text: 'Recent Files' });

    // Obtenir les fichiers récents
    const recentFiles = this.app.vault.getMarkdownFiles()
        .sort((a, b) => b.stat.mtime - a.stat.mtime)
        .slice(0, 10);

    const filesList = recentEl.createEl('ul');
    
    recentFiles.forEach(file => {
        const li = filesList.createEl('li');
        const link = li.createEl('a', {
            text: file.basename,
            href: '#'
        });
        
        link.addEventListener('click', (e) => {
            e.preventDefault();
            this.app.workspace.getLeaf().openFile(file);
        });
    });
}
```

## 🎨 Étape 5 : Styles CSS

### 5.1 Créer `styles.css`
```css
/* Container principal */
.homepage-container {
    padding: 20px;
    height: 100%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Titre */
.homepage-title {
    text-align: center;
    font-size: 3em;
    margin-bottom: 30px;
    color: var(--text-accent);
}

/* Barre de recherche */
.homepage-search-container {
    max-width: 600px;
    margin: 0 auto;
    width: 100%;
}

.homepage-search-input {
    width: 100%;
    padding: 12px 20px;
    border-radius: 25px;
    border: 2px solid var(--background-modifier-border);
    background: var(--background-primary);
    font-size: 1.1em;
}

/* Widgets */
.homepage-widgets {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.homepage-widget {
    background: var(--background-secondary);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.homepage-widget h3 {
    margin-top: 0;
    color: var(--text-accent);
    border-bottom: 2px solid var(--background-modifier-border);
    padding-bottom: 10px;
}

/* Listes dans les widgets */
.homepage-widget ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}

.homepage-widget li {
    padding: 5px 0;
}

.homepage-widget a {
    color: var(--text-normal);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background 0.2s;
}

.homepage-widget a:hover {
    background: var(--background-modifier-hover);
}
```

## ⚙️ Étape 6 : Panneau de paramètres

### 6.1 Implémenter les paramètres
```typescript
class HomepageSettingTab extends PluginSettingTab {
    plugin: HomepagePlugin;

    constructor(app: App, plugin: HomepagePlugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display(): void {
        const { containerEl } = this;
        containerEl.empty();

        containerEl.createEl('h2', { text: 'Homepage Settings' });

        // Titre personnalisé
        new Setting(containerEl)
            .setName('Custom Title')
            .setDesc('The title displayed on your homepage')
            .addText(text => text
                .setPlaceholder('My Homepage')
                .setValue(this.plugin.settings.customTitle)
                .onChange(async (value) => {
                    this.plugin.settings.customTitle = value;
                    await this.plugin.saveSettings();
                }));

        // Image de fond
        new Setting(containerEl)
            .setName('Background Image')
            .setDesc('URL or path to background image')
            .addText(text => text
                .setPlaceholder('https://example.com/image.jpg')
                .setValue(this.plugin.settings.backgroundImage)
                .onChange(async (value) => {
                    this.plugin.settings.backgroundImage = value;
                    await this.plugin.saveSettings();
                }));

        // Toggles pour les widgets
        new Setting(containerEl)
            .setName('Show Search Bar')
            .setDesc('Display search bar on homepage')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showSearch)
                .onChange(async (value) => {
                    this.plugin.settings.showSearch = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Show Bookmarks')
            .setDesc('Display bookmarks widget')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showBookmarks)
                .onChange(async (value) => {
                    this.plugin.settings.showBookmarks = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Show Recent Files')
            .setDesc('Display recent files widget')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showRecentFiles)
                .onChange(async (value) => {
                    this.plugin.settings.showRecentFiles = value;
                    await this.plugin.saveSettings();
                }));
    }
}
```

## 🏗️ Étape 7 : Compilation et installation

### 7.1 Compiler le plugin
```bash
# Mode développement (avec watch)
npm run dev

# Build de production
npm run build
```

### 7.2 Structure finale des fichiers
```
obsidian-homepage-plugin/
├── manifest.json
├── main.js           # Généré par esbuild
├── styles.css
├── main.ts           # Source TypeScript
└── versions.json
```

### 7.3 Installation dans Obsidian
1. Copier le dossier dans `.obsidian/plugins/`
2. Recharger Obsidian
3. Activer le plugin dans Settings → Community plugins

## 🚀 Étape 8 : Fonctionnalités avancées

### 8.1 Intégration avec d'autres plugins
```typescript
// Exemple : Intégration avec Dataview
private async createDataviewWidget(container: HTMLElement) {
    const dataviewAPI = (this.app as any).plugins.plugins.dataview?.api;
    
    if (dataviewAPI) {
        const widget = container.createEl('div', {
            cls: 'homepage-widget homepage-dataview'
        });
        
        // Exécuter une requête Dataview
        const pages = dataviewAPI.pages('"/"')
            .where(p => p.file.tags.includes("#important"))
            .limit(5);
        
        // Afficher les résultats
        const list = widget.createEl('ul');
        for (const page of pages) {
            const li = list.createEl('li');
            li.createEl('a', {
                text: page.file.name,
                href: page.file.path
            });
        }
    }
}
```

### 8.2 Widgets dynamiques avec API externes
```typescript
// Widget météo
private async createWeatherWidget(container: HTMLElement) {
    const widget = container.createEl('div', {
        cls: 'homepage-widget homepage-weather'
    });
    
    widget.createEl('h3', { text: 'Weather' });
    
    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${this.plugin.settings.city}&appid=${this.plugin.settings.weatherApiKey}`);
        const data = await response.json();
        
        widget.createEl('p', {
            text: `${data.main.temp}°C - ${data.weather[0].description}`
        });
    } catch (error) {
        widget.createEl('p', { text: 'Weather unavailable' });
    }
}
```

## 📚 Ressources et bonnes pratiques

### API Obsidian importantes
- `this.app.vault` : Accès aux fichiers du vault
- `this.app.workspace` : Gestion des vues et panneaux
- `this.app.metadataCache` : Cache des métadonnées
- `this.registerView()` : Enregistrer une vue personnalisée
- `this.addCommand()` : Ajouter des commandes
- `this.addSettingTab()` : Ajouter un panneau de paramètres

### Bonnes pratiques
1. **Performance** : Utiliser le lazy loading pour les widgets lourds
2. **Responsive** : Tester sur mobile si `isDesktopOnly: false`
3. **Thèmes** : Utiliser les variables CSS d'Obsidian
4. **Erreurs** : Toujours gérer les cas d'erreur
5. **Mémoire** : Nettoyer dans `onunload()`

### Publication
1. Créer un repository GitHub
2. Créer une release avec `manifest.json`, `main.js`, `styles.css`
3. Soumettre un PR sur [obsidian-releases](https://github.com/obsidianmd/obsidian-releases)

## 🐛 Debug et tests

### Console de développement
- Windows/Linux : `Ctrl+Shift+I`
- macOS : `Cmd+Option+I`

### Logs utiles
```typescript
console.log('Plugin loaded', this.manifest.name);
console.error('Error:', error);
```

### Hot reload
Le mode `npm run dev` recompile automatiquement à chaque modification.